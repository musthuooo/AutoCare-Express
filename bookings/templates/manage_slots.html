{% extends 'base.html' %}
{% load static %}
{% block title %}Manage Time Slots | AutoCare Express{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<style>
    body {
        background: linear-gradient(180deg, #eef6ff, #ffffff);
        font-family: "Poppins", sans-serif;
        padding-top: 40px;   /* ⭐ NEW TOP SPACE */
    }

    .container {
        max-width: 1180px;
        margin: 35px auto;
        padding: 5px 16px 0 16px;   /* ⭐ ADDED TOP PADDING */
        animation: fadeIn .5s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* ---------------- TOP HEADER ---------------- */
    .top-banner {
        display:flex;
        align-items:center;
        gap:20px;
        padding:26px 24px;
        border-radius:18px;
        background: linear-gradient(110deg, #0d47a1 0%, #1e88e5 100%);
        color:#fff;
        box-shadow:0 12px 32px rgba(13,71,161,0.25);
        margin-bottom:25px;
        position:relative;
        overflow:hidden;
    }
    .top-banner:after {
        content:"";
        position:absolute;
        right:-60px;
        top:-60px;
        width:180px;
        height:180px;
        border-radius:50%;
        background:rgba(255,255,255,0.09);
        filter:blur(6px);
    }
    .top-banner .icon {
        width:70px;
        height:70px;
        background:rgba(255,255,255,0.15);
        border-radius:16px;
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:2rem;
    }
    .top-banner h1 {
        margin:0;
        font-weight:800;
        font-size:1.55rem;
    }
    .top-banner p { margin:6px 0 0 0; opacity:.9; }

    .btn-back {
        margin-left:auto;
        background:#fff;
        color:#0d47a1;
        border-radius:30px;
        padding:10px 22px;
        font-weight:700;
        border:0;
        display:flex;
        align-items:center;
        gap:10px;
        box-shadow:0 8px 18px rgba(255,255,255,0.4);
        transition:.25s;
        pointer-events: auto;
        z-index: 5;
        position: relative;
    }
    .btn-back:hover {
        transform: translateX(-2px);
        box-shadow:0 10px 26px rgba(255,255,255,0.55);
    }

    /* ---------------- ADD SLOT BOX ---------------- */
    .slot-card {
        background:#ffffff;
        border-radius:16px;
        padding:24px 20px;
        margin-bottom:24px;
        box-shadow:0 10px 28px rgba(13,71,161,0.08);
        border:1px solid #e9eef9;
    }
    .slot-card h4 {
        color:#0d47a1;
        font-weight:800;
        margin-bottom:4px;
    }
    .slot-card small { color:#6c757d; }

    /* gradient action buttons */
    .btn-generate {
        background:linear-gradient(140deg,#0d6efd,#1e88e5);
        color:#fff;
        font-weight:700;
        border:none;
        border-radius:40px;
        padding:10px 22px;
        box-shadow:0 8px 26px rgba(30,136,229,0.28);
        transition:.25s;
    }
    .btn-generate:hover {
        transform:translateY(-2px);
        box-shadow:0 10px 32px rgba(30,136,229,0.38);
    }

    .btn-primary-cta {
        background:linear-gradient(135deg,#0d47a1,#1565c0);
        color:#fff;
        padding:10px 22px;
        border-radius:40px;
        border:0;
        font-weight:800;
        box-shadow:0 8px 22px rgba(13,71,161,0.18);
        transition:.25s;
    }
    .btn-primary-cta:hover {
        transform:translateY(-2px);
        box-shadow:0 10px 32px rgba(13,71,161,0.25);
    }

    .form-control {
        border-radius:12px;
        border:1.6px solid #dae6f7;
        padding:10px 12px;
        background:#fefeff;
        transition:.2s;
    }
    .form-control:focus {
        border-color:#0d47a1;
        box-shadow:0 6px 20px rgba(13,71,161,0.1);
    }

    /* ---------------- TABLE SECTION ---------------- */
    .table-card {
        background:#ffffff;
        border-radius:18px;
        padding:22px;
        box-shadow:0 10px 32px rgba(13,71,161,0.06);
        border:1px solid #e9eef9;
        margin-bottom:60px;
    }
    .table thead th {
        background:linear-gradient(110deg,#edf4ff,#fafcff);
        border-top:0;
        color:#0d47a1;
        text-align:center;
        font-weight:800;
        font-size:.95rem;
    }
    .table tbody td { text-align:center; vertical-align:middle; }

    .table tbody tr:hover {
        background:rgba(13,71,161,0.04);
        transition:.2s;
    }

    /* badges */
    .badge-available { background:#28a745; padding:6px 12px; border-radius:12px; color:#fff; font-weight:700; }
    .badge-unavailable { background:#6c757d; padding:6px 12px; border-radius:12px; color:#fff; font-weight:700; }
    .badge-booked { background:#d63384; padding:6px 12px; border-radius:12px; color:#fff; font-weight:700; }

    /* action buttons */
    .btn-pill {
        border-radius:40px;
        font-weight:700;
        padding:8px 16px;
        border:none;
        transition:.2s;
    }
    .btn-pill:hover { transform:translateY(-2px); }

    .btn-delete {
        background:#dc3545;
        color:#fff;
    }
    .btn-toggle {
        background:#fff;
        color:#0d47a1;
        border:2px solid #d5e2f8;
    }
    .btn-toggle:hover {
        background:#e3eeff;
    }
    .btn-save {
        background:#0d47a1;
        color:#fff;
        border-radius:12px;
        padding:6px 12px;
        border:none;
        font-weight:700;
    }

    .small-muted { color:#6c757d; font-size:0.95rem; margin-top:6px; }

</style>

<div class="container">

    <!-- ---------------- TOP HEADER ---------------- -->
    <div class="top-banner">
        <div class="icon"><i class="bi bi-clock-history"></i></div>

        <div>
            <h1>Manage Time Slots</h1>
            <p>Generate default slots, add custom ones, toggle availability, and control booking capacity.</p>
        </div>

        <a href="{% url 'bookings:supervisor_dashboard' %}" class="btn-back">
            <i class="bi bi-arrow-left-circle"></i> Back
        </a>
    </div>

    <!-- ---------------- ADD / GENERATE ---------------- -->
    <section class="slot-card">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <div>
                <h4><i class="bi bi-plus-circle me-1"></i> Add Time Slot</h4>
                <small>Add a custom slot or generate the automatic schedule.</small>
            </div>

            <form method="POST" class="d-inline" onsubmit="return confirm('Generate 09:00–18:00 / 30-min slots? (Excludes 13:00–14:00)');">
                {% csrf_token %}
                <input type="hidden" name="view_date" value="{{ view_date|date:'Y-m-d' }}">
                <button name="generate_slots" class="btn-generate">
                    <i class="bi bi-gear-wide-connected"></i> Generate Default
                </button>
            </form>
        </div>

        <form method="POST" class="row g-3 mt-3">
            {% csrf_token %}
            <input type="hidden" name="view_date" value="{{ view_date|date:'Y-m-d' }}">

            <div class="col-md-3">
                <label class="fw-semibold">Start Time</label>
                <input type="time" name="start_time" class="form-control" required>
            </div>

            <div class="col-md-3">
                <label class="fw-semibold">End Time</label>
                <input type="time" name="end_time" class="form-control" required>
            </div>

            <div class="col-md-4">
                <label class="fw-semibold">Note (optional)</label>
                <input type="text" name="note" class="form-control" placeholder="Eg: Morning Slot">
            </div>

            <div class="col-md-2 d-grid">
                <button type="submit" name="add_slot" class="btn-primary-cta">
                    <i class="bi bi-plus-lg"></i> Add
                </button>
            </div>
        </form>
    </section>

    <!-- ---------------- TABLE ---------------- -->
    <section class="table-card">
        <div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
            <div>
                <h5 class="fw-bold text-primary m-0"><i class="bi bi-list-ul me-1"></i> All Time Slots</h5>
                <small>Booking counts for <b>{{ view_date|date:"M d, Y" }}</b></small>
                <div class="small-muted">Status shown is for the selected date (i.e. availability on {{ view_date|date:"M d, Y" }}).</div>
            </div>

            <form method="GET" class="d-flex gap-2">
                <input type="date" name="view_date" value="{{ view_date|date:'Y-m-d' }}" class="form-control" style="max-width:160px;">
                <button class="btn-pill btn-toggle">Show</button>
            </form>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Start</th>
                        <th>End</th>
                        <th>Status (for date)</th>
                        <th>Booked</th>
                        <th>Capacity</th>
                        <th>Note</th>
                        <th>Actions</th>
                    </tr>
                </thead>

                <tbody>
                    {% for slot in timeslots %}
                    <tr>
                        <td>{{ forloop.counter }}</td>

                        <td>{{ slot.start_time|time:"g:i A" }}</td>
                        <td>{{ slot.end_time|time:"g:i A" }}</td>

                        <!-- STATUS now uses per-date availability -->
                        <td>
                            {% if slot.is_available_for_date %}
                                <span class="badge-available">Available</span>
                            {% else %}
                                <span class="badge-unavailable">Unavailable</span>
                            {% endif %}

                            <div style="font-size:0.85rem; color:#6c757d; margin-top:6px;">
                                {% if slot.booked_count > 0 %}
                                    {{ slot.booked_count }} booked
                                {% else %}
                                    No bookings
                                {% endif %}
                                &nbsp;/&nbsp;
                                {% if slot.capacity_effective %}
                                    {{ slot.capacity_effective }} cap
                                {% else %}
                                    {{ slot.capacity|default:"2" }} cap
                                {% endif %}
                            </div>
                        </td>

                        <td>
                            {% if slot.booked_count > 0 %}
                                <span class="badge-booked">{{ slot.booked_count }}</span>
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </td>

                        <td>
                            <!-- show capacity value (use capacity_effective if view provided it) -->
                            <form method="POST" class="d-flex gap-2 justify-content-center">
                                {% csrf_token %}
                                <input type="hidden" name="slot_id" value="{{ slot.id }}">
                                <input type="hidden" name="view_date" value="{{ view_date|date:'Y-m-d' }}">
                                {% if slot.capacity_effective %}
                                    <input type="number" min="1" name="capacity" value="{{ slot.capacity_effective }}" class="form-control" style="max-width:80px;">
                                {% else %}
                                    <input type="number" min="1" name="capacity" value="{{ slot.capacity }}" class="form-control" style="max-width:80px;">
                                {% endif %}
                                <button type="submit" name="update_capacity" class="btn-save">Save</button>
                            </form>
                        </td>

                        <td>{{ slot.note|default:"—" }}</td>

                        <td>
                            <div class="d-flex gap-2 justify-content-center flex-wrap">

                                <!-- Toggle: still toggles the global is_available flag -->
                                <form method="POST">
                                    {% csrf_token %}
                                    <input type="hidden" name="slot_id" value="{{ slot.id }}">
                                    <input type="hidden" name="view_date" value="{{ view_date|date:'Y-m-d' }}">
                                    <button name="toggle" class="btn-pill btn-toggle">
                                        {% if slot.is_available %}Disable{% else %}Enable{% endif %}
                                    </button>
                                </form>

                                <!-- Delete -->
                                <form method="POST" onsubmit="return confirm('Delete this slot?')">
                                    {% csrf_token %}
                                    <input type="hidden" name="slot_id" value="{{ slot.id }}">
                                    <input type="hidden" name="view_date" value="{{ view_date|date:'Y-m-d' }}">
                                    <button name="delete" class="btn-pill btn-delete"
                                            {% if slot.booked_count > 0 %}disabled title="Cannot delete slot with bookings on selected date"{% endif %}>
                                        Delete
                                    </button>
                                </form>

                            </div>
                        </td>
                    </tr>

                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center text-muted py-3">
                            No time slots created yet. Use the **Generate Default** button.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>

</div>
{% endblock %}
